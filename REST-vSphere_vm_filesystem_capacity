# V5 - see bottom for what remains to be done!
 
#This script queries vcenter for the list of VMs, gathers their disk usage info
#and calculates the percentage free.  The final part of the script sorts from least to
#greatest amount of space free
 
import requests
import json
import pandas as pd
import urllib3
import os
 
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
 
#Do not automate the fetching of a session key.
 
#Check for file and delete if needed
 
file_path = "C:\\Users\\rstuartii\\OneDrive - The Community College of Baltimore County\\Documents\\reggie\\VMware\\api\\stats"
 
if os.path.exists(file_path):
                os.remove(file_path)
                print("File removed.")
else:
                print("No file here")
 
#Get list of all VMs in the vcenter
 
headers = {
    'vmware-api-session-id': 'de577adc3144d0ba9bfb6f01bd0637f3',
}
 
params = {
    'power_states': 'POWERED_ON',
}
 
vcenter_vm_list = requests.get('https://cwvc2.ccbc.ccbcmd.edu/api/vcenter/vm', params=params, headers=headers, verify=False)
 
vvl = vcenter_vm_list.text
inventory = json.loads(vvl)
inventory_df = pd.DataFrame(inventory)
#filter on CW machines
cwindows = inventory_df[inventory_df['name'].str.contains("CW")]
 
#Isolate machine names and create list
machs = list(set(cwindows['vm']))
 
#Get stats from each machine and write to a file.
 
 
with open(r"C:\Users\rstuartii\OneDrive - The Community College of Baltimore County\Documents\reggie\VMware\api\stats", "a") as f:
 
    for x in machs:
        cmd = requests.get('https://cwvc2.ccbc.ccbcmd.edu/api/vcenter/vm/' + x + '/guest/local-filesystem', headers=headers, verify=False,)
        cmd
        dst = cmd.text
        disk_usage = json.loads(dst)
        dud = pd.DataFrame(disk_usage)
        dud.columns = dud.columns.str.replace(':', '')
        dud.columns = dud.columns.str.replace('\\', '')
 
        if 'C' in dud:
           
            free = dud.loc['free_space', 'C']
            cap = dud.loc['capacity', 'C']
            pfree = free/cap
            threed = round(pfree,3)
            printpercent = format(pfree, ".000%")
 
            print ("free space on " + x + "drive C:\ is " + printpercent + " percent of capacity", file=f)
 
        else:
            pass
 
##  MAP BACK TO CNAME, SORT, WRITE TO FILE
##        print(x, file=f)
##        print(data, file=f)
##        print('', file=f)
 
 
 
 
